// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/////////////////////////////////////////////////
// ENUMS
/////////////////////////////////////////////////

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum OtpPurpose {
  LOGIN
  REGISTER
  PASSWORD_RESET
  VERIFY_PHONE
}

/////////////////////////////////////////////////
// COMMERCE ENUMS
/////////////////////////////////////////////////

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  SHIPPED
  DELIVERED
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
}

enum CartStatus {
  ACTIVE
  CONVERTED
}

enum CouponType {
  FLAT
  PERCENTAGE
}

enum OfferType {
  FLAT
  PERCENTAGE
}

/////////////////////////////////////////////////
// USER
/////////////////////////////////////////////////

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone        String?  @unique
  passwordHash String?
  role         UserRole @default(CUSTOMER)

  isActive        Boolean @default(true)
  isEmailVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions           Session[]
  addresses          Address[]
  verificationTokens VerificationToken[]
  carts              Cart[]
  orders             Order[]
  favorites          Favorite[]
  reviews            Review[]

  @@index([email])
}

/////////////////////////////////////////////////
// SESSION (Refresh Token Storage)
/////////////////////////////////////////////////

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/////////////////////////////////////////////////
// VERIFICATION TOKENS (Email / Reset)
/////////////////////////////////////////////////

model VerificationToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType
  expiresAt DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/////////////////////////////////////////////////
// ADDRESS (Ecommerce Required)
/////////////////////////////////////////////////

model Address {
  id         String  @id @default(uuid())
  userId     String
  fullName   String
  phone      String
  line1      String
  line2      String?
  city       String
  state      String
  country    String
  postalCode String
  isDefault  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/////////////////////////////////////////////////
// BANNER
/////////////////////////////////////////////////

model Banner {
  id          String  @id @default(uuid())
  title       String?
  imageUrl    String
  redirectUrl String?
  position    Int     @default(0)

  isActive Boolean @default(true)

  startsAt DateTime?
  endsAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([position])
}

/////////////////////////////////////////////////
// PRODUCT
/////////////////////////////////////////////////

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  slug        String  @unique
  isActive Boolean @default(true)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  favorites  Favorite[]
  reviews    Review[]
  variants   ProductVariant[]
  attributes ProductAttribute[]
  images     ProductImage[]

  @@index([isActive])
  @@index([categoryId])
}

/////////////////////////////////////////////////
// CATEGORY
/////////////////////////////////////////////////

model Category {
  id       String  @id @default(uuid())
  name     String
  slug     String  @unique
  isActive Boolean @default(true)

  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([parentId])
  @@index([isActive])
}

/////////////////////////////////////////////////
// FAVORITE
/////////////////////////////////////////////////

model Favorite {
  id        String @id @default(uuid())
  userId    String
  productId String

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

/////////////////////////////////////////////////
// CART
/////////////////////////////////////////////////

model Cart {
  id     String     @id @default(uuid())
  userId String
  status CartStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([userId])
  @@index([status])
}

/////////////////////////////////////////////////
// CART ITEM
/////////////////////////////////////////////////

model CartItem {
  id        String @id @default(uuid())
  cartId    String
  productVariantId String
  quantity  Int

  priceSnapshot Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  cart             Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([cartId])
  @@index([productVariantId])
  @@unique([cartId, productVariantId])
}

/////////////////////////////////////////////////
// ORDER
/////////////////////////////////////////////////

model Order {
  id     String      @id @default(uuid())
  userId String
  status OrderStatus @default(PENDING)

  totalAmount Decimal @db.Decimal(12, 2)
  currency    String  @default("INR")

  addressSnapshot Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User        @relation(fields: [userId], references: [id])
  items          OrderItem[]
  payments       Payment[]
  couponId       String?
  coupon         Coupon?     @relation(fields: [couponId], references: [id])
  discountAmount Decimal?    @db.Decimal(12, 2)

  @@index([userId])
  @@index([status])
}

/////////////////////////////////////////////////
// ORDER ITEM
/////////////////////////////////////////////////

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productVariantId String

  productNameSnapshot String
  priceSnapshot       Decimal @db.Decimal(10, 2)
  quantity            Int
  totalPrice          Decimal @db.Decimal(12, 2)

  order            Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([orderId])
}

/////////////////////////////////////////////////
// PAYMENT
/////////////////////////////////////////////////

model Payment {
  id                String        @id @default(uuid())
  orderId           String
  provider          String
  providerPaymentId String?
  amount            Decimal       @db.Decimal(12, 2)
  status            PaymentStatus @default(INITIATED)
  idempotencyKey String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

/////////////////////////////////////////////////
// COUPON
/////////////////////////////////////////////////

model Coupon {
  id    String     @id @default(uuid())
  code  String     @unique
  type  CouponType
  value Decimal    @db.Decimal(10, 2)

  minOrderAmount Decimal? @db.Decimal(10, 2)
  maxDiscount    Decimal? @db.Decimal(10, 2)

  usageLimit Int?
  usedCount  Int  @default(0)

  isActive Boolean @default(true)

  startsAt DateTime?
  endsAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@index([code])
  @@index([isActive])
}

/////////////////////////////////////////////////
// PRODUCT OFFER
/////////////////////////////////////////////////

model ProductOffer {
  id        String    @id @default(uuid())
  variantId String
  type      OfferType
  value     Decimal   @db.Decimal(10, 2)

  startsAt DateTime?
  endsAt   DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([isActive])
}

model Review {
  id        String  @id @default(uuid())
  userId    String
  productId String
  rating    Int // 1â€“5
  comment   String?

  isApproved Boolean @default(false)

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
}

model ProductVariant {
  id        String  @id @default(uuid())
  slug      String  @unique
  productId String
  sku       String  @unique
  name      String // e.g., "Medium / Red" or "256GB / Silver"
  price     Decimal @db.Decimal(10, 2)
  stock     Int     @default(0)

  product Product @relation(fields: [productId], references: [id])

  // Connect cart/order items to variants instead of products
  cartItems  CartItem[]
  orderItems OrderItem[]
  offers     ProductOffer[]
  images     ProductImage[]

  @@index([productId])
}

model ProductAttribute {
  id        String @id @default(uuid())
  productId String
  name      String // e.g., "Color", "RAM", "Spiciness"
  value     String // e.g., "Blue", "16GB", "Extra Hot"

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductImage {
  id        String  @id @default(uuid())
  productId String
  variantId String?
  url       String
  isMain    Boolean @default(false)
  altText   String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
}
